document.addEventListener('DOMContentLoaded', function () {
   const body = document.querySelector('body');

   // Левый "внешний" мир
   const leftSide = document.createElement('div');
   leftSide.classList.add('outside', 'zone');

   // Правый "тюремный" мир
   const rightSide = document.createElement('div');
   rightSide.classList.add('inside', 'zone');

   // Добавляем оба раздела на экран
   body.append(leftSide, rightSide);

   // Переменные для отслеживания состояния
   let currentCharacter = null;
   let cursorX = 0;
   let cursorY = 0;

   // Обработчик для обновления позиции курсора
   document.addEventListener('mousemove', (event) => {
      cursorX = event.clientX;
      cursorY = event.clientY;

      if (currentCharacter && currentCharacter.classList.contains('follow')) {
         const jail = rightSide.getBoundingClientRect();
         const charWidth = currentCharacter.offsetWidth;
         const charHeight = currentCharacter.offsetHeight;
         
         if (
            cursorX >= jail.left &&
            cursorX <= jail.right &&
            cursorY >= jail.top &&
            cursorY <= jail.bottom
         ) {
            currentCharacter.classList.add('trapped');
            currentCharacter.style.background = 'var(--orange)';
            

            // Перемещаем персонажа с ограничением границ тюрьмы
            let clampedX = Math.min(
               Math.max(cursorX, jail.left + charWidth / 2),
               jail.right - charWidth / 2
            );
            let clampedY = Math.min(
               Math.max(cursorY, jail.top + charHeight / 2),
               jail.bottom - charHeight / 2
            );

            currentCharacter.style.left = `${clampedX - charWidth / 2}px`;
            currentCharacter.style.top = `${clampedY - charHeight / 2}px`;
         } else {
            if (currentCharacter.classList.contains('trapped')) {
               currentCharacter.classList.remove('follow');
            } else {
               
               // Персонаж может свободно двигаться вне тюрьмы
               currentCharacter.style.left = `${cursorX - charWidth / 2}px`;
               currentCharacter.style.top = `${cursorY - charHeight / 2}px`;
            }
         }
      }
   });

   // Обработчик нажатия клавиш
   document.addEventListener('keydown', (event) => {
      const key = event.key;

      // Если нажата клавиша Escape, удаляем всех персонажей
      if (key === 'Escape') {
         document.querySelectorAll('.character').forEach((char) => char.remove());
         currentCharacter = null;
         return;
      }

      // Если нажата буква (a-z)
      if (/^[a-z]$/.test(key)) {
         // Если уже есть персонаж, отцепляем его
         if (currentCharacter) {
            currentCharacter.classList.remove('follow');
         }

         // Создаем новый элемент персонажа
         const character = document.createElement('div');
         character.classList.add('character', 'follow');
         character.textContent = key;

         // Установить начальную позицию персонажа
         character.style.position = 'absolute';
         character.style.left = `${cursorX - 15}px`;
         character.style.top = `${cursorY - 15}px`;
         character.style.background = 'rgb(255, 255, 255)';

         // Проверяем, находится ли курсор в тюрьме
         const jail = rightSide.getBoundingClientRect();
         if (
            cursorX >= jail.left &&
            cursorX <= jail.right &&
            cursorY >= jail.top &&
            cursorY <= jail.bottom
         ) {
            character.classList.add('trapped');
            character.style.background = 'var(--orange)';
            
         }

         // Добавляем персонажа на страницу
         body.append(character);
         currentCharacter = character;
      }
   });
});